# Internationalization (i18n)

This document describes the i18n architecture, design decisions, and conventions for the DCA Analyzer.

## Overview

The app supports two locales with URL-prefix routing:

| Locale | URL Prefix | Role | Audience |
|--------|-----------|------|----------|
| `en` | `/en/...` | **Default** (primary, fallback) | International users |
| `zh` | `/zh/...` | Translation | Chinese-speaking users |

Visiting `/` redirects to `/en` via proxy.

## Library: next-intl

**Why next-intl**: First-class Next.js App Router support, lightweight, type-safe, ICU message syntax, active community. Officially recommended by Next.js docs.

**Core APIs used**:
- `useTranslations(namespace)` — client/server components
- `getTranslations(namespace)` — async server contexts (metadata, etc.)
- `createMiddleware()` — locale detection and routing (used inside `proxy.ts`)
- `createNavigation()` — locale-aware `Link`, `useRouter`, etc.

## Translation Style

**Localized adaptation (意译), not literal translation.**

Each locale should feel native to its audience. Chinese and English texts are independently crafted — no strict 1:1 correspondence. Example:

| Key | English | Chinese |
|-----|---------|---------|
| `title` | Position Simulator | 仓位模拟器 |
| `strategy.pyramid.tooltip` | Buy more as price drops | 越跌越买，低位重仓 |

## File Structure

```
i18n/
  routing.ts        — defineRouting: locales, defaultLocale
  request.ts        — getRequestConfig: loads messages JSON per locale
  navigation.ts     — createNavigation: locale-aware Link, useRouter, etc.

messages/
  en.json           — English (primary)
  zh.json           — Simplified Chinese

proxy.ts            — next-intl routing via Next.js 16 proxy convention

app/
  [locale]/
    layout.tsx      — LocaleLayout (NextIntlClientProvider, html lang)
    page.tsx        — main page (moved from app/page.tsx)

components/
  locale-switcher.tsx  — EN/中 toggle in header
```

## Message Namespace Structure

```json
{
  "meta": { "title", "description" },
  "common": { "collapse", "settings", "reset", "custom" },
  "config": { "title", "assetName", "unit", "totalSize", "targetPrice", "targetDate", "priceLevels", "priceLevelsHint", "empty", "bottomRange", "recommended", "minPrice", "maxPrice", "step", "warning" },
  "strategy": { "title", "pyramid.*", "uniform.*", "inverted.*", "custom.*", "totalWeight" },
  "slider": { "title", "keyboardHint" },
  "chart": { "profitComparison", "areaView", "curveView", "priceAxis", "positionAxis", "profitAxis", "bottomAxis", "profit", "profitFormula" },
  "advice": { "title", "recommended", "coverage", "noProfit", "bestIn" },
  "validation": { "needLevel", "targetTooLow", "bottomTooHigh", "minAboveMax" }
}
```

## Key Design Decision: lib Layer Stays Pure

`lib/advice.ts` and `lib/strategies.ts` previously returned Chinese strings directly. After i18n, they return **structured data only** (keys + variables). The UI layer (`advice-panel.tsx`, `strategy-selector.tsx`) is responsible for calling `t()` to render translated text.

This preserves the architecture principle: lib functions are pure calculations with zero UI/i18n dependencies.

```
Before:  strategies.ts → STRATEGY_LABELS.pyramid.name = "金字塔"
         advice.ts     → StrategyAdvice.bestStrategy.label = "金字塔"
         advice.ts     → AdviceSegment.range = "> $0.30" (formatted string)

After:   strategies.ts → STRATEGY_LABELS removed entirely
         advice.ts     → StrategyAdvice.bestStrategy.name = "pyramid" (key only)
         advice.ts     → AdviceSegment stores raw price boundaries, not formatted strings
         UI layer      → t(`strategy.pyramid.name`), t("advice.bestIn")
```

## Language Switcher

Minimal toggle in the header, next to the settings button. Uses `useRouter` and `usePathname` from `i18n/navigation.ts` to switch locale while preserving the current path.

Design: two text buttons `EN / 中`, current locale highlighted.
